<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>마이페이지 | 호텔어라운드 평창</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/auth.css">
</head>
<body class="auth-page">
  <!-- Navigation -->
  <nav class="nav scrolled" id="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo">
        <span class="logo-text">HOTEL AROUND</span>
        <span class="logo-sub">PYEONGCHANG</span>
      </a>
      <ul class="nav-menu">
        <li><a href="index.html#packages">패키지</a></li>
        <li><a href="index.html#rooms">객실</a></li>
        <li><a href="index.html#contact">문의</a></li>
      </ul>
    </div>
  </nav>

  <main class="mypage-wrapper">
    <div class="mypage-container">
      <!-- User Header -->
      <div class="mypage-header">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">H</div>
          <div class="user-details">
            <h2 id="userName">회원</h2>
            <p id="userEmail">email@example.com</p>
            <span class="user-badge">MEMBER</span>
          </div>
        </div>
        <button class="btn-logout" onclick="logout()">로그아웃</button>
      </div>

      <!-- Tab Navigation -->
      <div class="mypage-tabs">
        <button class="mypage-tab active" data-tab="reservations">예약 내역</button>
        <button class="mypage-tab" data-tab="inquiries">문의 내역</button>
        <button class="mypage-tab" data-tab="profile">회원정보</button>
      </div>

      <!-- Content -->
      <div class="mypage-content">
        <!-- Reservations Tab -->
        <section class="mypage-section active" id="reservations">
          <h3 class="section-title">예약 내역</h3>
          <div class="reservation-list" id="reservationList">
            <!-- Reservations will be loaded here -->
          </div>
        </section>

        <!-- Inquiries Tab -->
        <section class="mypage-section" id="inquiries">
          <h3 class="section-title">문의 내역</h3>
          <div class="inquiry-list" id="inquiryList">
            <!-- Inquiries will be loaded here -->
          </div>
        </section>

        <!-- Profile Tab -->
        <section class="mypage-section" id="profile">
          <h3 class="section-title">회원정보 수정</h3>
          <form class="profile-form" id="profileForm">
            <div class="form-row">
              <div class="form-group">
                <label for="profileName">이름</label>
                <input type="text" id="profileName" name="name" required>
              </div>
              <div class="form-group">
                <label for="profilePhone">연락처</label>
                <input type="tel" id="profilePhone" name="phone" required>
              </div>
            </div>

            <div class="form-group">
              <label for="profileEmail">이메일</label>
              <input type="email" id="profileEmail" name="email" readonly>
            </div>

            <div class="form-group">
              <label for="profileCompany">회사/소속</label>
              <input type="text" id="profileCompany" name="company">
            </div>

            <div class="form-group">
              <label>현재 비밀번호</label>
              <input type="password" id="currentPassword" name="currentPassword" placeholder="변경 시에만 입력">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>새 비밀번호</label>
                <input type="password" id="newPassword" name="newPassword" placeholder="8자 이상">
              </div>
              <div class="form-group">
                <label>새 비밀번호 확인</label>
                <input type="password" id="newPasswordConfirm" name="newPasswordConfirm" placeholder="비밀번호 재입력">
              </div>
            </div>

            <div class="form-group" style="margin-top: 2rem;">
              <label class="checkbox-label">
                <input type="checkbox" name="agreeMarketing" id="profileMarketing">
                <span>마케팅 정보 수신 동의</span>
              </label>
            </div>

            <button type="submit" class="btn-save">저장하기</button>
          </form>
        </section>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      loadUserData();
      initMypageTabs();
      loadReservations();
      loadInquiries();
      initProfileForm();
    });

    /**
     * Check Authentication
     */
    function checkAuth() {
      const session = getSession();
      if (!session) {
        window.location.href = 'login.html';
      }
    }

    function getSession() {
      return JSON.parse(localStorage.getItem('workationSession')) ||
             JSON.parse(sessionStorage.getItem('workationSession'));
    }

    /**
     * Load User Data
     */
    function loadUserData() {
      const session = getSession();
      if (!session) return;

      document.getElementById('userAvatar').textContent = session.name.charAt(0);
      document.getElementById('userName').textContent = session.name;
      document.getElementById('userEmail').textContent = session.email;

      // Load full user data for profile
      const users = JSON.parse(localStorage.getItem('workationUsers') || '[]');
      const user = users.find(u => u.id === session.id);

      if (user) {
        document.getElementById('profileName').value = user.name || '';
        document.getElementById('profilePhone').value = user.phone || '';
        document.getElementById('profileEmail').value = user.email || '';
        document.getElementById('profileCompany').value = user.company || '';
        document.getElementById('profileMarketing').checked = user.agreeMarketing || false;
      }
    }

    /**
     * Tab Navigation
     */
    function initMypageTabs() {
      const tabs = document.querySelectorAll('.mypage-tab');
      const sections = document.querySelectorAll('.mypage-section');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          sections.forEach(s => s.classList.remove('active'));

          tab.classList.add('active');
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });
    }

    /**
     * Load Reservations
     */
    function loadReservations() {
      const session = getSession();
      const users = JSON.parse(localStorage.getItem('workationUsers') || '[]');
      const user = users.find(u => u.id === session.id);
      const reservations = user?.reservations || [];

      const container = document.getElementById('reservationList');

      if (reservations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <h3>예약 내역이 없습니다</h3>
            <p>프리미엄 워케이션을 시작해 보세요</p>
            <a href="index.html#packages" class="btn btn-primary">패키지 둘러보기</a>
          </div>
        `;
        return;
      }

      container.innerHTML = reservations.map(r => `
        <div class="reservation-card">
          <div class="reservation-image" style="background-image: url('https://images.unsplash.com/photo-1590490360182-c33d57733427?w=300')"></div>
          <div class="reservation-info">
            <h4>${r.packageName}</h4>
            <p>체크인: ${formatDate(r.checkin)}</p>
            <p>인원: ${r.guests}명</p>
          </div>
          <div class="reservation-status">
            <span class="status-badge ${r.status}">${getStatusText(r.status)}</span>
            <p class="price">${r.price?.toLocaleString()}원</p>
          </div>
        </div>
      `).join('');
    }

    /**
     * Load Inquiries
     */
    function loadInquiries() {
      const session = getSession();
      const inquiries = JSON.parse(localStorage.getItem('workationInquiries') || '[]');
      const userInquiries = inquiries.filter(i => i.email === session.email);

      const container = document.getElementById('inquiryList');

      if (userInquiries.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            <h3>문의 내역이 없습니다</h3>
            <p>워케이션 관련 문의사항이 있으시면 언제든 연락주세요</p>
            <a href="index.html#contact" class="btn btn-primary">문의하기</a>
          </div>
        `;
        return;
      }

      container.innerHTML = userInquiries.map(i => `
        <div class="reservation-card">
          <div class="reservation-info" style="grid-column: span 2;">
            <h4>${getPackageName(i.package) || '일반 문의'}</h4>
            <p>문의일: ${formatDate(i.timestamp)}</p>
            <p style="margin-top: 0.5rem; color: #666;">${i.message || '문의 내용 없음'}</p>
          </div>
          <div class="reservation-status">
            <span class="status-badge ${i.status}">${i.status === 'pending' ? '답변 대기' : '답변 완료'}</span>
          </div>
        </div>
      `).join('');
    }

    /**
     * Profile Form
     */
    function initProfileForm() {
      const form = document.getElementById('profileForm');

      // Phone formatting
      const phoneInput = document.getElementById('profilePhone');
      phoneInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.slice(0, 11);
        if (value.length > 7) {
          value = value.replace(/(\d{3})(\d{4})(\d{0,4})/, '$1-$2-$3');
        } else if (value.length > 3) {
          value = value.replace(/(\d{3})(\d{0,4})/, '$1-$2');
        }
        e.target.value = value;
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        const session = getSession();
        const users = JSON.parse(localStorage.getItem('workationUsers') || '[]');
        const userIndex = users.findIndex(u => u.id === session.id);

        if (userIndex === -1) return;

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const newPasswordConfirm = document.getElementById('newPasswordConfirm').value;

        // Validate password change
        if (newPassword) {
          if (users[userIndex].password !== currentPassword) {
            showNotification('error', '현재 비밀번호가 올바르지 않습니다.');
            return;
          }
          if (newPassword.length < 8) {
            showNotification('error', '새 비밀번호는 8자 이상이어야 합니다.');
            return;
          }
          if (newPassword !== newPasswordConfirm) {
            showNotification('error', '새 비밀번호가 일치하지 않습니다.');
            return;
          }
          users[userIndex].password = newPassword;
        }

        // Update user data
        users[userIndex].name = document.getElementById('profileName').value;
        users[userIndex].phone = document.getElementById('profilePhone').value;
        users[userIndex].company = document.getElementById('profileCompany').value;
        users[userIndex].agreeMarketing = document.getElementById('profileMarketing').checked;

        localStorage.setItem('workationUsers', JSON.stringify(users));

        // Update session
        session.name = users[userIndex].name;
        session.phone = users[userIndex].phone;
        session.company = users[userIndex].company;
        localStorage.setItem('workationSession', JSON.stringify(session));

        showNotification('success', '회원정보가 수정되었습니다.');
        loadUserData();

        // Clear password fields
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('newPasswordConfirm').value = '';
      });
    }

    /**
     * Logout
     */
    function logout() {
      localStorage.removeItem('workationSession');
      sessionStorage.removeItem('workationSession');
      window.location.href = 'index.html';
    }

    /**
     * Helper Functions
     */
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
    }

    function getStatusText(status) {
      const texts = {
        pending: '예약 대기',
        confirmed: '예약 확정',
        completed: '이용 완료'
      };
      return texts[status] || '확인 중';
    }

    function getPackageName(value) {
      const names = {
        bronze: 'Bronze - 7박 패키지',
        silver: 'Silver - 14박 패키지',
        gold: 'Gold - 30박 패키지',
        custom: '기업 맞춤 패키지'
      };
      return names[value];
    }

    function showNotification(type, message) {
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();

      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `<div class="notification-content"><span>${message}</span></div>`;

      const colors = { success: '#27ae60', error: '#e74c3c', info: '#3498db' };
      notification.style.cssText = `
        position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
        background: ${colors[type]}; color: white; padding: 1rem 2rem;
        border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 3000; animation: slideDown 0.3s ease;
      `;

      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }
  </script>
</body>
</html>
